<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finanzas de la Farmacia</title>

<link rel="stylesheet" href="styles.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card">
  <h2>Acceso</h2>
  <input type="password" id="pin" placeholder="PIN">
  <button onclick="verificarPIN()">Entrar</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<header>
  <h1>Finanzas de la Farmacia</h1>
  <p>Panel financiero</p>
  <button id="modoBtn" onclick="toggleModo()">Modo oscuro</button>
</header>

<section class="card">
  <h2>Periodo</h2>
  <select id="tipoPeriodo">
    <option>Semanal</option>
    <option>Mensual</option>
    <option>Bimestral</option>
  </select>

  <label>Periodo</label>
  <input id="periodo" placeholder="Ej. Marzo 2026">

  <label>Ingresos</label>
  <input type="number" id="ingresos">

  <label>Gastos</label>
  <input type="number" id="gastos">
</section>

<section class="card">
  <h2>Distribución (%)</h2>

  <label>Reinversión</label>
  <input type="number" id="pReinversion" value="60">

  <label>Fondo libre</label>
  <input type="number" id="pLibre" value="30">

  <label>Ahorro</label>
  <input type="number" id="pAhorro" value="10">
</section>

<section class="card">
  <h2>Meta financiera (ahorro)</h2>
  <input type="number" id="metaAhorro" placeholder="Ej. 50000">
  <div id="estadoMeta"></div>
</section>

<button onclick="guardar()">Guardar y analizar</button>

<section class="card">
  <h2>Resumen</h2>
  <div id="resumen"></div>
</section>

<section class="card">
  <h2>Distribución del dinero</h2>
  <canvas id="graficaDistribucion"></canvas>
</section>

<section class="card">
  <h2>Comparación histórica</h2>
  <canvas id="graficaComparativa"></canvas>
</section>

<section class="card">
  <h2>Exportar</h2>
  <button onclick="exportarExcel()">Excel</button>
  <button onclick="exportarPDF()">PDF</button>
</section>

</div>

<script>
let chartDist = null;
let chartComp = null;

/* ===== PIN ===== */
function verificarPIN(){
  const p = pin.value;
  const guardado = localStorage.getItem("pin");

  if(!guardado){
    localStorage.setItem("pin", p);
    alert("PIN creado");
  }

  if(p === localStorage.getItem("pin")){
    login.style.display = "none";
    app.style.display = "block";
    cargarTodo();
  } else {
    alert("PIN incorrecto");
  }
}

/* ===== MODO OSCURO ===== */
function toggleModo(){
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "modo",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
}

if(localStorage.getItem("modo") === "dark"){
  document.body.classList.add("dark");
}

/* ===== GUARDAR ===== */
function guardar(){
  const ing = Number(ingresos.value);
  const gas = Number(gastos.value);

  if(!periodo.value || ing <= 0){
    alert("Completa periodo e ingresos");
    return;
  }

  const utilidad = ing - gas;

  const data = {
    periodo: periodo.value,
    ingresos: ing,
    gastos: gas,
    utilidad: utilidad,
    reinversion: utilidad * Number(pReinversion.value) / 100,
    libre: utilidad * Number(pLibre.value) / 100,
    ahorro: utilidad * Number(pAhorro.value) / 100,
    fecha: Date.now()
  };

  localStorage.setItem("fin_" + data.fecha, JSON.stringify(data));

  if(metaAhorro.value){
    localStorage.setItem("metaAhorro", metaAhorro.value);
  }

  cargarTodo();
}

/* ===== OBTENER REGISTROS ===== */
function obtenerRegistros(){
  return Object.keys(localStorage)
    .filter(k => k.startsWith("fin_"))
    .map(k => JSON.parse(localStorage[k]))
    .sort((a,b)=>a.fecha - b.fecha);
}

/* ===== CARGAR TODO ===== */
function cargarTodo(){
  resumenUI();
  graficaDistribucionUI();
  graficaComparativaUI();
  metaUI();
}

/* ===== RESUMEN ===== */
function resumenUI(){
  const regs = obtenerRegistros();
  if(!regs.length) return;

  const d = regs[regs.length - 1];

  resumen.innerHTML = `
    <strong>Periodo:</strong> ${d.periodo}<br>
    <strong>Ingresos:</strong> $${d.ingresos}<br>
    <strong>Gastos:</strong> $${d.gastos}<br>
    <strong>Utilidad:</strong> $${d.utilidad}<br><br>
    <strong>Reinversión:</strong> $${d.reinversion}<br>
    <strong>Fondo libre:</strong> $${d.libre}<br>
    <strong>Ahorro:</strong> $${d.ahorro}
  `;
}

/* ===== DISTRIBUCIÓN ===== */
function graficaDistribucionUI(){
  const regs = obtenerRegistros();
  if(!regs.length) return;

  const d = regs[regs.length - 1];

  if(chartDist) chartDist.destroy();

  chartDist = new Chart(graficaDistribucion, {
    type: "doughnut",
    data: {
      labels: ["Reinversión", "Fondo libre", "Ahorro"],
      datasets: [{
        data: [d.reinversion, d.libre, d.ahorro],
        backgroundColor: ["#2563eb", "#6b7280", "#16a34a"]
      }]
    }
  });
}

/* ===== COMPARATIVA ===== */
function graficaComparativaUI(){
  const regs = obtenerRegistros();
  if(!regs.length) return;

  if(chartComp) chartComp.destroy();

  chartComp = new Chart(graficaComparativa, {
    type: "bar",
    data: {
      labels: regs.map(r => r.periodo),
      datasets: [
        { label: "Ingresos", data: regs.map(r => r.ingresos), backgroundColor: "#2563eb" },
        { label: "Gastos", data: regs.map(r => r.gastos), backgroundColor: "#dc2626" },
        { label: "Utilidad", data: regs.map(r => r.utilidad), backgroundColor: "#16a34a" }
      ]
    }
  });
}

/* ===== META ===== */
function metaUI(){
  const meta = Number(localStorage.getItem("metaAhorro"));
  if(!meta) return;

  const regs = obtenerRegistros();
  const acumulado = regs.reduce((s,r)=>s + r.ahorro, 0);

  estadoMeta.innerHTML = `
    Meta: $${meta}<br>
    Ahorro acumulado: $${acumulado}<br>
    Estado: ${acumulado >= meta ? "Meta alcanzada" : "En progreso"}
  `;
}

/* ===== EXPORTAR ===== */
function exportarExcel(){
  const regs = obtenerRegistros();
  const ws = XLSX.utils.json_to_sheet(regs);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Finanzas");
  XLSX.writeFile(wb, "finanzas_farmacia.xlsx");
}

function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Finanzas de la Farmacia", 20, 20);

  let y = 30;
  obtenerRegistros().forEach(r=>{
    pdf.text(`${r.periodo} | Utilidad: $${r.utilidad}`, 20, y);
    y += 8;
  });

  pdf.save("finanzas_farmacia.pdf");
}
</script>

</body>
</html>
